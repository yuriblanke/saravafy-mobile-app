<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Abrir no Saravafy</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/config.js"></script>
  </head>
  <body>
    <main class="container">
      <h1 id="pontoTitle">Carregando ponto…</h1>
      <p id="subtitle" class="meta"></p>

      <div class="card">
        <div class="row">
          <button id="installBtn" class="btn-primary" disabled>
            Instalar app
          </button>
          <button id="openBtn" class="btn-secondary" disabled>
            Abrir no app
          </button>
        </div>

        <p class="notice">Se o app já estiver instalado, use “Abrir no app”.</p>

        <p id="shortCode" class="meta"></p>

        <p id="status" class="small"></p>
      </div>
    </main>

    <script>
      (function () {
        const titleEl = document.getElementById("pontoTitle");
        const subtitleEl = document.getElementById("subtitle");
        const installBtn = document.getElementById("installBtn");
        const openBtn = document.getElementById("openBtn");
        const shortCodeEl = document.getElementById("shortCode");
        const statusEl = document.getElementById("status");

        const supabaseUrl = String(window.SARAVAFY_SUPABASE_URL || "").trim();
        const anonKey = String(window.SARAVAFY_SUPABASE_ANON_KEY || "").trim();
        const hasSupabaseConfig = !!supabaseUrl && !!anonKey;

        const CROCKFORD_ALPHABET = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";

        function isUuid(value) {
          return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(
            String(value || "").trim()
          );
        }

        function uuidToBytes(uuid) {
          const hex = String(uuid).replace(/-/g, "");
          const out = new Uint8Array(16);
          for (let i = 0; i < 16; i++) {
            out[i] = parseInt(hex.slice(i * 2, i * 2 + 2), 16);
          }
          return out;
        }

        function base32CrockfordEncode(bytes) {
          let bits = 0;
          let value = 0;
          let out = "";

          for (let i = 0; i < bytes.length; i++) {
            value = (value << 8) | bytes[i];
            bits += 8;

            while (bits >= 5) {
              const idx = (value >>> (bits - 5)) & 31;
              out += CROCKFORD_ALPHABET[idx];
              bits -= 5;
            }
          }

          if (bits > 0) {
            const idx = (value << (5 - bits)) & 31;
            out += CROCKFORD_ALPHABET[idx];
          }

          return out;
        }

        function setStatus(text, variant) {
          statusEl.textContent = text;
          statusEl.className = "small" + (variant === "error" ? " error" : "");
        }

        function parseLink() {
          const path = String(window.location.pathname || "");
          const parts = path.split("/").filter(Boolean);
          // Expected: /l/ponto/<uuid>
          if (parts.length >= 3 && parts[0] === "l" && parts[1] === "ponto") {
            return { tipo: "ponto", id: parts[2] };
          }
          return null;
        }

        function isValidHttpsUrl(url) {
          try {
            const u = new URL(url);
            return u.protocol === "https:";
          } catch {
            return false;
          }
        }

        async function fetchInstallUrl() {
          if (!supabaseUrl || !anonKey) {
            return {
              url: null,
              reason: "Config do Supabase ausente na landing.",
            };
          }

          const endpointBase =
            supabaseUrl.replace(/\/+$/, "") +
            "/rest/v1/public_app_config?select=value&key=eq.app_install_url&limit=1";

          // Cache-buster to defeat intermediary caches.
          const endpoint = endpointBase + "&t=" + Date.now();

          const res = await fetch(endpoint, {
            method: "GET",
            cache: "no-store",
            headers: {
              apikey: anonKey,
              Authorization: "Bearer " + anonKey,
              "Cache-Control": "no-store, no-cache, must-revalidate, max-age=0",
              Pragma: "no-cache",
              Accept: "application/json",
            },
          });

          if (!res.ok) {
            return {
              url: null,
              reason:
                "Falha ao buscar link de instalação (HTTP " + res.status + ")",
            };
          }

          const data = await res.json();
          const row = Array.isArray(data) && data.length > 0 ? data[0] : null;
          const value =
            row && typeof row.value === "string" ? row.value.trim() : "";

          if (!value) {
            return { url: null, reason: "Link de instalação não configurado." };
          }

          if (!isValidHttpsUrl(value)) {
            return {
              url: null,
              reason: "Link de instalação inválido (esperado https://).",
            };
          }

          return { url: value, reason: null };
        }

        async function fetchPontoTitle(pontoId) {
          if (!supabaseUrl || !anonKey) {
            return {
              title: null,
              reason: "Config do Supabase ausente na landing.",
            };
          }

          const endpointBase =
            supabaseUrl.replace(/\/+$/, "") +
            "/rest/v1/pontos?select=title,artist&id=eq." +
            encodeURIComponent(pontoId) +
            "&is_active=eq.true&restricted=eq.false&limit=1";

          const endpoint = endpointBase + "&t=" + Date.now();

          const res = await fetch(endpoint, {
            method: "GET",
            cache: "no-store",
            headers: {
              apikey: anonKey,
              Authorization: "Bearer " + anonKey,
              "Cache-Control": "no-store, no-cache, must-revalidate, max-age=0",
              Pragma: "no-cache",
              Accept: "application/json",
            },
          });

          if (!res.ok) {
            return {
              title: null,
              reason: "Falha ao buscar o ponto (HTTP " + res.status + ")",
            };
          }

          const data = await res.json();
          const row = Array.isArray(data) && data.length > 0 ? data[0] : null;
          const title =
            row && typeof row.title === "string" ? row.title.trim() : "";
          const artist =
            row && typeof row.artist === "string" ? row.artist.trim() : "";
          const fullTitle = [title, artist].filter(Boolean).join(" — ");
          return { title: fullTitle || null, reason: null };
        }

        const installDefaultLabel = installBtn.textContent || "Instalar app";
        let installBusy = false;

        function setInstallBusy(isBusy) {
          installBusy = !!isBusy;
          installBtn.disabled = installBusy;
          installBtn.textContent = installBusy
            ? "Carregando…"
            : installDefaultLabel;
        }

        function setInstallEnabled(isEnabled) {
          if (installBusy) return;
          installBtn.disabled = !isEnabled;
          installBtn.textContent = installDefaultLabel;
        }

        async function refreshInstallAvailability() {
          setStatus("Carregando link de instalação…");

          try {
            const result = await fetchInstallUrl();
            if (result.url) {
              setInstallEnabled(true);
              setStatus("Pronto para instalar.");
              return;
            }

            setInstallEnabled(false);
            setStatus(
              result.reason || "Não foi possível obter o link de instalação.",
              "error"
            );
          } catch {
            setInstallEnabled(false);
            setStatus("Erro ao buscar o link de instalação.", "error");
          }
        }

        const parsed = parseLink();
        const href = window.location.href;

        if (!parsed || !isUuid(parsed.id)) {
          subtitleEl.textContent = "Link inválido.";
          titleEl.textContent = "Não foi possível abrir este ponto.";
          setStatus("Link inválido.", "error");
          installBtn.disabled = true;
          openBtn.disabled = true;
          return;
        }

        subtitleEl.textContent = "UUID: " + parsed.id;
        openBtn.disabled = false;

        const shortCode = base32CrockfordEncode(uuidToBytes(parsed.id));
        shortCodeEl.textContent = "Código: " + shortCode;

        openBtn.addEventListener("click", function () {
          if (hasSupabaseConfig) {
            setStatus("Abrindo…");
          }
          window.location.href = href;
        });

        installBtn.addEventListener("click", async function () {
          if (installBusy) return;

          if (!hasSupabaseConfig) {
            // Fallback de dev mode: mantém UI útil sem depender de fetch.
            return;
          }

          // Always refetch on click to ensure the freshest install URL.
          setInstallBusy(true);
          setStatus("Buscando link de instalação…");

          try {
            const result = await fetchInstallUrl();
            if (result.url) {
              setStatus("Redirecionando…");
              window.location.href = result.url;
              return;
            }

            setStatus(
              result.reason || "Não foi possível obter o link de instalação.",
              "error"
            );
          } catch {
            setStatus("Erro ao buscar o link de instalação.", "error");
          } finally {
            setInstallBusy(false);
          }
        });

        if (!hasSupabaseConfig) {
          // Dev fallback (opção C): não inicializa/faz fetch no Supabase.
          titleEl.textContent = "Ponto do Saravafy";
          installBtn.disabled = true;
          statusEl.textContent = "";
          statusEl.style.display = "none";
          return;
        }

        void refreshInstallAvailability();

        void (async function () {
          try {
            const result = await fetchPontoTitle(parsed.id);
            if (result.title) {
              titleEl.textContent = result.title;
              return;
            }
            titleEl.textContent = "Abrir ponto";
            if (result.reason) {
              setStatus(result.reason, "error");
            }
          } catch {
            titleEl.textContent = "Abrir ponto";
          }
        })();
      })();
    </script>
  </body>
</html>
